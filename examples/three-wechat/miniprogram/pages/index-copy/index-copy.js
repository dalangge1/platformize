"use strict";var e=require("../../chunks/three-platformize.js"),a=require("../../chunks/screenshot.js");function o(e){let a,o=e[0],t=1;for(;t<e.length;){const s=e[t],r=e[t+1];if(t+=2,("optionalAccess"===s||"optionalCall"===s)&&null==o)return;"access"===s||"optionalAccess"===s?(a=o,o=r(o)):"call"!==s&&"optionalCall"!==s||(o=r(((...e)=>o.call(a,...e))),a=void 0)}return o}const t={MemoryTest:a.DemoMemoryTest,MeshOpt:a.DemoMeshOpt,TGALoader:a.DemoTGALoader,PDBLoader:a.DemoPDBLoader,STLLoader:a.DemoSTLLoader,TTFLoader:a.DemoTTFLoader,BVHLoader:a.DemoBVHLoader,FBXLoader:a.DemoFBXLoader,LWOLoader:a.DemoLWOLoader,MTLLoader:a.DemoMTLLoader,EXRLoader:a.DemoEXRLoader,OBJLoader:a.DemoOBJLoader,SVGLoader:a.DemoSVGLoader,RGBELoader:a.DemoRGBELoader,GLTFLoader:a.DemoGLTFLoader,ColladaLoader:a.DemoColladaLoader,MeshQuantization:a.DemoMeshQuantization,ThreeSpritePlayer:a.DemoThreeSpritePlayer,HDRPrefilterTexture:a.DemoHDRPrefilterTexture,DeviceOrientationControls:a.DemoDeviceOrientationControls},s=e=>new Promise((a=>wx.createSelectorQuery().select(e).fields({node:!0,size:!0}).exec(a)));Page({disposing:!1,switchingItem:!1,deps:{},currDemo:null,platform:null,helperCanvas:null,data:{showMenu:!0,showCanvas:!1,currItem:-1,menuList:["GLTFLoader","ThreeSpritePlayer","DeviceOrientationControls","RGBELoader","SVGLoader","OBJLoader","MeshOpt","EXRLoader","HDRPrefilterTexture","MTLLoader","LWOLoader","FBXLoader","BVHLoader","ColladaLoader","MeshQuantization","TTFLoader","STLLoader","PDBLoader","TGALoader","MemoryTest"]},onReady(){this.onCanvasReady()},onCanvasReady(){console.log("onCanvasReady"),Promise.all([s("#gl"),s("#canvas")]).then((([e,a])=>{this.initCanvas(e[0].node,a[0].node)}))},initCanvas(t,s){const r=new a.WechatPlatform(t);this.platform=r,r.enableDeviceOrientation("game"),e.PLATFORM.set(r),console.log(e.$window.innerWidth,e.$window.innerHeight),console.log(t.width,t.height);const i=new e.WebGL1Renderer({canvas:t,antialias:!0,alpha:!0}),n=new e.PerspectiveCamera(75,t.width/t.height,.1,1e3),d=new e.Scene,l=new e.Clock,h=new a.GLTFLoader,c=new e.TextureLoader;this.deps={renderer:i,camera:n,scene:d,clock:l,gltfLoader:h,textureLoader:c},this.helperCanvas=s,d.position.z=-3,i.outputEncoding=e.sRGBEncoding,i.setSize(t.width,t.height),i.setPixelRatio(e.$window.devicePixelRatio);const L=()=>{this.disposing||(e.$requestAnimationFrame(L),o([this.currDemo,"optionalAccess",e=>e.update,"call",e=>e()]),i.render(d,n))};L(),console.log("canvas inited")},onMenuClick(){const e=!this.data.showMenu;e?this.setData({showMenu:e,showCanvas:!1}):(this.setData({showMenu:e}),setTimeout((()=>{this.setData({showCanvas:!0})}),330))},async onMenuItemClick(e){const{i:a,item:s}=e.currentTarget.dataset;if(wx.showLoading({mask:!1,title:"加载中"}),this.switchingItem||!t[s])return;o([this.currDemo,"optionalAccess",e=>e.dispose,"call",e=>e()]),this.switchingItem=!0,this.currDemo=null;const r=new t[s](this.deps);await r.init(),this.currDemo=r,this.setData({currItem:a}),this.onMenuClick(),this.switchingItem=!1,wx.hideLoading()},onTX(e){this.platform.dispatchTouchEvent(e),this.platform.dispatchTouchEvent(e)},screenshot(){const{renderer:o,scene:t,camera:s}=this.deps,[r,i,n]=a.screenshot(o,t,s,e.WebGLRenderTarget),d=this.helperCanvas.getContext("2d"),l=this.helperCanvas.createImageData(r,i,n);this.helperCanvas.height=l.height,this.helperCanvas.width=l.width,d.putImageData(l,0,0);const h=d.getImageData(0,0,i,n).data.some((e=>0!==e));console.log("hasPixel",h),wx.canvasToTempFilePath({canvas:this.helperCanvas,success(e){wx.previewImage({urls:[e.tempFilePath]})}})},onUnload(){this.disposing=!0,o([this.currDemo,"optionalAccess",e=>e.dispose,"call",e=>e()]),e.PLATFORM.dispose()}});
